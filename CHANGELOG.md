# Changelog

All notable changes to Int Crucible will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Fixed
- **Story 014: Streaming UI improvements** (2025-01-17)
  - Fixed highlighting fade behavior: only border color fades, text remains fully readable
    - Changed `.highlight-recent` and `.highlight-fading` to use `rgba()` opacity on border color only
    - Removed element-level `opacity` that was fading text unnecessarily
  - Fixed input field behavior: input remains enabled while agent is replying
    - Input field only disabled when no chat session exists (removed `isSending` check)
    - Send button correctly disabled during agent replies (`isGeneratingReply` check)
    - Users can now type and edit their next message while waiting for agent response
    - Enter key still prevented from sending while agent is replying

### Added
- **Story 013: Spec/World-Model Deltas and Live Highlighting** (Implementation)
  - Backend delta computation:
    - `_compute_spec_delta` method in `ProblemSpecService` computes structured deltas comparing current vs updated ProblemSpec
    - `_compute_world_model_delta` method in `WorldModelService` computes structured deltas from agent changes
    - Delta structures include: `touched_sections`, `constraints` (added/updated/removed), `goals` (added/updated/removed), `resolution_changed`, `mode_changed`
    - Deltas stored in Architect message `message_metadata` for timeline reconstruction
    - Fallback logic infers deltas from user queries when frontend refinement happens first
  - Frontend delta display:
    - `DeltaSummary` component shows compact one-line summaries in Architect messages (e.g., "Spec update: +1 constraint, 2 constraints updated")
    - Expandable `[Details]` toggle reveals per-item change information
    - Human-readable format with proper pluralization
  - Live highlighting in spec panel:
    - Individual constraint/goal tracking with delta-based ordering (newest = most vibrant)
    - Three highlight levels: `highlight-newest` (3px green border, full opacity), `highlight-recent` (2px, 0.7 opacity), `highlight-fading` (2px, 0.4 opacity)
    - Border-only highlighting (no background) for clean visual design
    - Highlights driven by structured deltas from message metadata, not UI heuristics
    - Proper padding alignment between Goals and Constraints sections
  - Timeline reconstruction:
    - Deltas persist in message metadata, enabling reconstruction of spec/world-model evolution
    - Stable delta structure suitable for future provenance work (Story 008)
  - Comprehensive browser testing:
    - All acceptance criteria verified in live UI
    - Tested delta summaries, highlighting, fading, and newest item detection
    - Fixed delta-based fading (not time-based) and individual item tracking
- **Story 012: Architect-led Conversational Loop and Full Interaction Logging** (Implementation)
  - Architect auto-reply functionality:
    - Automatic Architect responses after every user message (removed "Get Help" button requirement)
    - New API endpoint `/chat-sessions/{id}/architect-reply` for generating Architect replies
    - Architect persona clearly labeled in UI with `agent_name: "Architect"` metadata
    - Workflow-aware guidance based on project state (setup/ready_to_run/completed)
  - Full conversational logging:
    - All user messages, Architect responses, and system events stored in `crucible_messages`
    - Structured metadata includes: `workflow_stage`, `guidance_type`, `agent_name`, `suggested_actions`
    - Error handling creates system messages instead of breaking conversation flow
    - Complete interaction log enables future analysis and UX improvements
  - GuidanceService enhancements:
    - `_determine_guidance_type()` method categorizes guidance (spec_refinement, clarification, run_recommendation, etc.)
    - Metadata enrichment for all Architect responses
    - Tool-based approach for dynamic system queries
  - Frontend improvements:
    - Auto-focus on chat input when entering chat mode and after Architect replies
    - Loading indicators: "Sending..." and "Architect is replying..." states
    - Inline system/error messages in chat (no alerts)
    - Fixed SpecPanel scrolling with proper flex layout and nested scroll containers
    - Fixed WorkflowProgress text color (changed from blue to gray to avoid confusion with clickable elements)
    - Fixed chat input visibility (ensured input area remains visible with proper flex constraints)
  - Architecture documentation:
    - Added "Conversational Logging" section to `docs/architecture.md`
    - Documents decision to treat conversations as canonical interaction log
  - Comprehensive browser testing:
    - All acceptance criteria verified in live UI
    - Tested auto-reply functionality, UI labeling, error handling, and conversation flow
    - All UI issues identified and resolved
- **Story 008b: Test Tooling and Run Execution Fixes** (Implementation)
  - Run execution fixes:
    - Added session refresh (`session.expire_all()`) to fix "ProblemSpec or WorldModel not found" errors
    - Enhanced error messages with available projects list for better debugging
    - Fixed run status reporting to prevent overwriting "completed" status
    - Added comprehensive logging with phase tags and timing information
  - Test tooling CLI command (`crucible test-run`):
    - Execute full pipeline with detailed progress reporting
    - Verify existing runs with `--verify-only` flag
    - Custom candidate/scenario counts
    - Automatic verification of run completeness and data integrity
    - Rich formatted output with tables and progress indicators
  - Verification utilities (`crucible/services/run_verification.py`):
    - `verify_run_completeness()` - Checks all expected entities exist
    - `verify_data_integrity()` - Validates relationships and foreign keys
    - `get_run_statistics()` - Provides detailed run statistics
  - Comprehensive instrumentation:
    - Phase-level logging with timing for all pipeline phases
    - Entity count logging (candidates, scenarios, evaluations)
    - Clear phase identification with tags like `[Design Phase]`, `[Phase 1/2]`
  - Unit tests:
    - 11 test cases for verification utilities
    - 7 test cases for run service improvements
    - Total: 18 unit tests covering error handling, status reporting, and verification
  - E2E test script (`scripts/test_e2e_008b.py`):
    - Tests with real database data
    - Validates error handling, verification utilities, and session refresh fix
    - All 4 E2E test scenarios passing
  - Story document updated with implementation details and E2E test results
- **Stories 012-016: Comprehensive Architect-Centric Chat Experience** (Story definitions)
  - **Story 012: Architect-led conversational loop and full interaction logging**
    - Replaces Story 008c with comprehensive architect persona approach
    - Automatic Architect responses after every user message (removes "Get Help" button requirement)
    - Full conversational logging with structured metadata (workflow_stage, guidance_type, related IDs)
    - All interactions stored in `crucible_messages` for future analysis and improvement
    - Error handling via system messages in chat instead of alerts
  - **Story 013: Spec/world-model deltas and live highlighting**
    - ProblemSpec/WorldModel refinements return structured delta summaries
    - Compact "Spec update" lines in Architect replies with expandable details
    - Spec panel visual highlighting with recency-based fade (most recent = vibrant, older = subtle)
    - Delta information stored in message metadata for analyzable interaction log
  - **Story 014: Streaming architect responses and typing indicators**
    - Backend streaming support (SSE or StreamingResponse) for Architect replies
    - Frontend streaming consumption with live message updates and auto-scroll
    - Typing/busy indicator bubble in chat ("Architect is thinking...")
    - Input area busy state feedback without freezing UI
    - Graceful error handling with fallback to full response if streaming fails
    - Final messages stored as coherent single entries in database
  - **Story 015: Chat-first project creation and selection**
    - Project creation moved into conversational flow (Architect greets, asks what you're working on)
    - Architect infers project title/description from user's natural language response
    - Project selector remains for multi-project management but creation is chat-driven
    - All project creation steps logged as part of conversation transcript
  - **Story 016: Run advisor contract and explicit execution control**
    - Architect only advises on run configuration, never executes runs
    - Run execution always requires explicit user button click (budget protection)
    - Architect recommendations (mode, config) logged with metadata
    - Post-run summaries from Architect logged as conversational events
  - All stories prioritized as High
  - Story 008c superseded and removed (ideas migrated into 012-016)
- **Story 007b: Interactive Guidance and Onboarding Agent** (Implementation)
  - GuidanceAgent (`crucible/agents/guidance_agent.py`) - AI-native guidance agent that explains Int Crucible workflow, provides contextual help, and suggests next steps
    - Uses tool-based approach for dynamic system queries
    - Provides natural language guidance rather than rigid templates
    - Adapts to project state (ProblemSpec, WorldModel, runs) for contextual suggestions
  - GuidanceService (`crucible/services/guidance_service.py`) - Orchestrates guidance operations with tool creation
    - Creates callable tools for querying project state, ProblemSpec, WorldModel, runs, and messages
    - Determines workflow stage and provides state-aware guidance
  - API endpoints for guidance:
    - `POST /chat-sessions/{chat_session_id}/guidance` - Request guidance for a chat session
    - `GET /projects/{project_id}/workflow-state` - Get current workflow state for contextual guidance
  - Frontend integration:
    - "Get Help" button in ChatInterface for requesting guidance
    - WorkflowProgress component showing project progress through ProblemSpec → WorldModel → Run stages
    - Guidance messages displayed in chat interface
  - Comprehensive test suite:
    - 3 unit tests for GuidanceAgent (`tests/unit/agents/test_guidance_agent.py`)
  - Story document updated with implementation details and design philosophy
- **Story 011: Native LLM Function Calling for Guidance Agent** (Story definition)
  - Created story document for future enhancement to use native LLM function calling (Claude tool use, OpenAI functions)
  - Currently guidance agent uses prompt-based tool descriptions; future enhancement will enable true tool invocation
  - Prioritized as Medium
- **Story 007: Chat-First Web UI** (UI improvements)
  - Auto-focus on project title input when create form opens
  - Prerequisites checking in Run Config panel (shows warning if ProblemSpec/WorldModel missing)
  - Improved error messages for missing prerequisites
  - Timezone display fixes (properly converts UTC to local time)
  - Devtools indicator hiding (prevents blocking chat input)
  - Hydration warning suppression (handles browser extension modifications)
- **Story 006: Evaluators and I-Ranker**
  - EvaluatorAgent (`crucible/agents/evaluator_agent.py`) - Evaluates candidates against scenarios, producing structured P (prediction quality), R (resource cost), and constraint satisfaction scores
  - EvaluatorService (`crucible/services/evaluator_service.py`) - Orchestrates evaluation operations with database integration
  - RankerService (`crucible/services/ranker_service.py`) - Aggregates evaluations, computes I = P/R metric, and flags hard constraint violations (weight >= 100)
  - Enhanced RunService with evaluation and ranking phases:
    - `execute_evaluation_phase()` - Evaluate all candidates against all scenarios
    - `execute_ranking_phase()` - Rank candidates based on evaluations
    - `execute_evaluate_and_rank_phase()` - Combined evaluation + ranking phase
    - `execute_full_pipeline()` - Complete pipeline: Design → Scenarios → Evaluation → Ranking
  - API endpoints for evaluation and ranking:
    - `POST /runs/{run_id}/evaluate` - Evaluate all candidates in a run
    - `POST /runs/{run_id}/rank` - Rank candidates based on evaluations
    - `POST /runs/{run_id}/evaluate-and-rank` - Execute evaluate + rank phase
    - `POST /runs/{run_id}/full-pipeline` - Execute complete pipeline
  - Comprehensive test suite:
    - 6 unit tests for EvaluatorAgent (`tests/unit/agents/test_evaluator_agent.py`)
    - 4 unit tests for EvaluatorService (`tests/unit/services/test_evaluator_service.py`)
    - 5 unit tests for RankerService (`tests/unit/services/test_ranker_service.py`)
- **Story 005: Designers and ScenarioGenerator**
  - DesignerAgent (`crucible/agents/designer_agent.py`) - Generates diverse candidate solutions from WorldModel
  - ScenarioGeneratorAgent (`crucible/agents/scenario_generator_agent.py`) - Produces scenario suites that stress critical constraints and assumptions
  - DesignerService (`crucible/services/designer_service.py`) - Orchestrates candidate generation with provenance tracking
  - ScenarioService (`crucible/services/scenario_service.py`) - Orchestrates scenario suite generation
  - RunService (`crucible/services/run_service.py`) - Orchestrates complete design + scenario generation phase
  - API endpoints for design and scenario generation:
    - `POST /runs/{run_id}/generate-candidates` - Generate candidates for a run
    - `POST /runs/{run_id}/generate-scenarios` - Generate scenario suite for a run
    - `POST /runs/{run_id}/design-and-scenarios` - Execute full design + scenario phase
  - Candidate and ScenarioSuite JSON schema documentation (`docs/candidate-scenario-schema.md`)
  - Comprehensive test suite:
    - 6 unit tests for DesignerAgent (`tests/unit/agents/test_designer_agent.py`)
    - 6 unit tests for ScenarioGeneratorAgent (`tests/unit/agents/test_scenario_generator_agent.py`)
    - 4 unit tests for DesignerService (`tests/unit/services/test_designer_service.py`)
    - 4 unit tests for ScenarioService (`tests/unit/services/test_scenario_service.py`)
    - 10 integration tests for design + scenario generation flow (`tests/integration/test_design_scenario_flow.py`)
- WorldModeller agent (`crucible/agents/worldmodeller_agent.py`) - Builds structured world models from ProblemSpec and chat context
- WorldModel service (`crucible/services/worldmodel_service.py`) - Orchestrates WorldModel operations with provenance tracking
- WorldModel API endpoints:
  - `GET /projects/{project_id}/world-model` - Retrieve WorldModel
  - `POST /projects/{project_id}/world-model/refine` - Refine WorldModel via agent
  - `PUT /projects/{project_id}/world-model` - Manual WorldModel updates
- WorldModel JSON schema documentation (`docs/world-model-schema.md`)
- Comprehensive test suite:
  - 12 unit tests for WorldModellerAgent (`tests/unit/agents/test_worldmodeller_agent.py`)
  - 13 unit tests for WorldModelService (`tests/unit/services/test_worldmodel_service.py`)
  - 8 integration tests for ProblemSpec → WorldModel flow (`tests/integration/test_problemspec_worldmodel_flow.py`)
- Integration test infrastructure (`tests/integration/conftest.py`) with file-based SQLite database fixture

### Changed
- Updated `crucible/db/repositories.py` - Added graceful error handling for `session.refresh()` in `create_world_model()`
- Updated `tests/conftest.py` - Added fixtures for WorldModeller testing and improved SQLite threading support
- Updated Story 004 work log with implementation details
- Updated `frontend/components/RunConfigPanel.tsx` - Added prerequisites checking with visual warnings
- Updated `frontend/components/ChatInterface.tsx` - Fixed timezone parsing and display
- Updated `frontend/components/ProjectSelector.tsx` - Added auto-focus functionality
- Updated `frontend/app/layout.tsx` - Added suppressHydrationWarning for browser extensions
- Updated `frontend/app/globals.css` - Added CSS rules to hide devtools indicators
- Updated `frontend/next.config.ts` - Disabled build activity indicator
- Updated `docs/stories.md` - Added Story 007b, Story 008b, and Story 011 to story index
- Updated `frontend/components/ChatInterface.tsx` - Added "Get Help" button and guidance message handling
- Updated `frontend/app/page.tsx` - Integrated WorkflowProgress component
- Updated `frontend/lib/api.ts` - Added guidance API client functions
- Updated `.gitignore` - Added `.playwright-mcp/` directory

### Fixed
- SQLite threading issues in integration tests by using file-based database instead of in-memory
- Repository `session.refresh()` edge cases in WorldModel creation
- Timezone display issue in chat messages (now correctly converts UTC to local time)
- Devtools indicator blocking chat input area
- React hydration warnings from browser extensions
- Run Config error handling (now shows helpful prerequisites warning instead of generic error)

## [0.1.0] - 2025-01-17

### Added
- Initial project structure
- ProblemSpec agent and service (Story 003)
- Domain schema and database models (Story 002)
- Basic API endpoints for ProblemSpec operations
- CLI interface
- Kosmos integration

